import React, { useState, useEffect, useMemo } from 'react';
// Usamos importación compatible con ESM para navegadores y Vite
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import { 
  Calendar as CalendarIcon, 
  BarChart2, 
  Settings, 
  Plus, 
  Filter, 
  ShieldCheck, 
  Instagram, 
  Linkedin, 
  Facebook, 
  Image as ImageIcon, 
  Video, 
  Film, 
  Layers, 
  ChevronLeft, 
  ChevronRight, 
  Lock, 
  User, 
  CheckCircle, 
  Clock, 
  Edit3,
  FileText, 
  X,
  Trash2,
  Eye,
  MoreHorizontal,
  Search,
  Activity,
  Share2,
  StickyNote,
  Zap,
  Home,           
  AlertTriangle,  
  Bell,
  BookOpen,
  Lightbulb,
  ArrowRight,
  Save,
  Grid,
  LogOut,
  Briefcase,
  Sparkles,
  Menu,
  TrendingUp,
  PieChart,
  Wand2,
  CheckSquare, 
  Target, 
  Globe,
  CalendarDays,
  PenTool, 
  Ruler, 
  Repeat,
  Database
} from 'lucide-react';

// --- CONFIGURACIÓN DE COLORES Y ESTILOS ---
const THEME = {
    bg: 'bg-[#F8FAFC]',
    sidebar: 'bg-[#0f172a]',
    sidebarText: 'text-slate-300',
    accent: 'indigo',
    glass: 'bg-white/80 backdrop-blur-md border border-white/60 shadow-lg'
};

const CONTENT_TYPES = {
  REEL: { id: 'reel', label: 'Reel', icon: Film, color: 'text-rose-500', bg: 'bg-rose-50', badge: 'bg-rose-100 text-rose-600' },
  CLIP: { id: 'clip', label: 'Clip', icon: Video, color: 'text-orange-500', bg: 'bg-orange-50', badge: 'bg-orange-100 text-orange-600' },
  UGC: { id: 'ugc', label: 'UGC', icon: User, color: 'text-emerald-500', bg: 'bg-emerald-50', badge: 'bg-emerald-100 text-emerald-600' },
  IMAGE: { id: 'image', label: 'Imagen', icon: ImageIcon, color: 'text-cyan-500', bg: 'bg-cyan-50', badge: 'bg-cyan-100 text-cyan-600' },
  CAROUSEL: { id: 'carousel', label: 'Carrusel', icon: Layers, color: 'text-violet-500', bg: 'bg-violet-50', badge: 'bg-violet-100 text-violet-600' },
  NOTE: { id: 'note', label: 'Nota', icon: StickyNote, color: 'text-yellow-500', bg: 'bg-yellow-50', badge: 'bg-yellow-100 text-yellow-600' },
};

const NETWORKS = {
  INSTAGRAM: { id: 'instagram', label: 'Instagram', icon: Instagram, color: 'text-pink-600' },
  LINKEDIN: { id: 'linkedin', label: 'LinkedIn', icon: Linkedin, color: 'text-blue-700' },
  TIKTOK: { id: 'tiktok', label: 'TikTok', icon: Video, color: 'text-black' },
  FACEBOOK: { id: 'facebook', label: 'Facebook', icon: Facebook, color: 'text-blue-600' },
};

const STATUS_CONFIG = {
  idea: { label: 'Idea', color: 'text-fuchsia-600 bg-fuchsia-50', dot: 'bg-fuchsia-500' },
  proposal: { label: 'Propuesta', color: 'text-slate-500 bg-slate-50 border-dashed border-slate-300', dot: 'bg-slate-300' },
  draft: { label: 'Borrador', color: 'text-slate-600 bg-white border-slate-200', dot: 'bg-indigo-400' },
  ready: { label: 'Listo', color: 'text-indigo-700 bg-indigo-50', dot: 'bg-indigo-500' },
  scheduled: { label: 'Programado', color: 'text-emerald-700 bg-emerald-50', dot: 'bg-emerald-500' }
};

const CLIENT_THEMES = [
  { theme: 'from-blue-600 to-cyan-500', shadow: 'shadow-blue-500/30' },
  { theme: 'from-violet-600 to-fuchsia-600', shadow: 'shadow-violet-500/30' },
  { theme: 'from-emerald-500 to-teal-400', shadow: 'shadow-emerald-500/30' },
  { theme: 'from-rose-500 to-pink-500', shadow: 'shadow-rose-500/30' },
  { theme: 'from-slate-700 to-slate-900', shadow: 'shadow-slate-500/30' },
];

const GlassCard = ({ children, className = '', onClick }) => (
    <div onClick={onClick} className={`${THEME.glass} rounded-3xl transition-all duration-300 hover:shadow-xl hover:-translate-y-1 ${className}`}>
        {children}
    </div>
);

// --- PANTALLA DE CONFIGURACIÓN / LOGIN ---
const ConfigScreen = ({ onConnect }) => {
    const [url, setUrl] = useState('');
    const [key, setKey] = useState('');

    return (
        <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-8 text-center font-sans">
            <div className="max-w-md w-full bg-white rounded-[2.5rem] p-10 shadow-2xl relative overflow-hidden">
                 <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600 shadow-inner">
                    <Database size={32} />
                </div>
                <h2 className="text-3xl font-black text-slate-900 mb-2">CORIA OS <span className="text-indigo-600 text-lg align-top">v2.0</span></h2>
                <p className="text-slate-500 mb-8 font-medium text-sm">Conecta tu base de datos Supabase para iniciar el sistema.</p>
                
                <form onSubmit={(e) => { e.preventDefault(); onConnect(url, key); }} className="space-y-4 text-left">
                    <div>
                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">URL del Proyecto</label>
                        <input value={url} onChange={e=>setUrl(e.target.value)} type="text" placeholder="https://xyz.supabase.co" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-medium outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <div>
                         <label className="text-xs font-bold text-slate-400 uppercase ml-1">API Key (Anon)</label>
                         <input value={key} onChange={e=>setKey(e.target.value)} type="password" placeholder="eyJhbGciOiJIUzI1NiIsInR5..." className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-medium outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <button type="submit" disabled={!url || !key} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition-all disabled:opacity-50 mt-2 shadow-lg shadow-slate-900/20">
                        Conectar Sistema
                    </button>
                </form>
                
                <div className="mt-8 pt-6 border-t border-slate-100">
                    <p className="text-xs text-slate-400 mb-3">¿Solo quieres ver el diseño?</p>
                    <button onClick={() => onConnect('demo', 'demo')} className="px-6 py-2 rounded-full border border-slate-200 text-slate-600 font-bold text-xs hover:bg-slate-50 transition-colors uppercase tracking-widest">
                        Entrar en Modo Demo
                    </button>
                </div>
            </div>
        </div>
    )
}

// --- APP PRINCIPAL ---
export default function CoriaManager() {
  const [supabase, setSupabase] = useState(null);
  const [isDemo, setIsDemo] = useState(false);
  const [loading, setLoading] = useState(false); // Estado de carga global
  
  // Datos
  const [clients, setClients] = useState([]);
  const [posts, setPosts] = useState([]);
  
  // Navegación
  const [selectedClient, setSelectedClient] = useState(null);
  const [currentView, setCurrentView] = useState('planning'); // planning, inbox, tasks, extras
  
  // Estados UI
  const [currentDate, setCurrentDate] = useState(new Date());
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [newPost, setNewPost] = useState({});
  const [showPlanGenerator, setShowPlanGenerator] = useState(false);

  // --- CONEXIÓN ---
  const handleConnect = (url, key) => {
      setLoading(true);
      if (url === 'demo') {
          setIsDemo(true);
          // Datos Dummy para Demo
          setClients([
              { id: '1', name: 'TechSolutions', logo: 'TS', theme: 'from-blue-600 to-cyan-500' },
              { id: '2', name: 'Gourmet Market', logo: 'GM', theme: 'from-orange-500 to-amber-400' },
              { id: '3', name: 'CORIA Agency', logo: 'CO', theme: 'from-violet-600 to-fuchsia-600' }
          ]);
          setPosts([
              { id: '101', title: 'Post Demo 1', date: new Date().toISOString().split('T')[0], type: 'image', status: 'draft', client_id: '1', networks: ['instagram'] }
          ]);
          setLoading(false);
      } else {
          try {
              const client = createClient(url, key);
              setSupabase(client);
              // Iniciar listeners reales
              // En un entorno real de React, esto iría en useEffects separados
          } catch (error) {
              alert("Error de conexión. Revisa las credenciales.");
              setLoading(false);
          }
      }
  };

  // --- EFECTOS DE CARGA (SIMULADOS PARA DEMO / REALES PARA SUPABASE) ---
  useEffect(() => {
      if (!supabase) return;

      const fetchData = async () => {
          setLoading(true);
          const { data: clientsData } = await supabase.from('clients').select('*');
          if (clientsData) setClients(clientsData);
          
          const { data: postsData } = await supabase.from('posts').select('*');
          if (postsData) setPosts(postsData);
          setLoading(false);
      };

      fetchData();
      
      // Realtime Subscriptions
      const channel = supabase.channel('schema-db-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, payload => {
             // Lógica simple de actualización para el ejemplo
             if(payload.eventType === 'INSERT') setPosts(prev => [...prev, payload.new]);
             if(payload.eventType === 'UPDATE') setPosts(prev => prev.map(p => p.id === payload.new.id ? payload.new : p));
             if(payload.eventType === 'DELETE') setPosts(prev => prev.filter(p => p.id !== payload.old.id));
        })
        .subscribe();

      return () => { supabase.removeChannel(channel); }
  }, [supabase]);

  // --- HELPERS CRUD (Abstractos para Demo/Supabase) ---
  const createItem = async (table, data) => {
      if (isDemo) {
          const newItem = { ...data, id: Math.random().toString(36).substr(2, 9), created_at: new Date().toISOString() };
          if(table==='clients') setClients([...clients, newItem]);
          if(table==='posts') setPosts([...posts, newItem]);
          return newItem;
      } else {
          const { data: res } = await supabase.from(table).insert([data]).select();
          return res?.[0];
      }
  };

  const updateItem = async (table, id, data) => {
      if (isDemo) {
          if(table==='posts') setPosts(posts.map(p => p.id === id ? { ...p, ...data } : p));
      } else {
          await supabase.from(table).update(data).eq('id', id);
      }
  };

  const deleteItem = async (table, id) => {
      if (isDemo) {
          if(table==='posts') setPosts(posts.filter(p => p.id !== id));
      } else {
          await supabase.from(table).delete().eq('id', id);
      }
  };

  // --- LÓGICA DE NEGOCIO ---
  
  const handleAddClient = async (name, packageSize) => {
      const randomTheme = CLIENT_THEMES[Math.floor(Math.random() * CLIENT_THEMES.length)];
      const logo = name.substring(0,2).toUpperCase();
      const newClient = await createItem('clients', { name, logo, theme: randomTheme.theme });
      
      if(packageSize > 0 && newClient) {
          await generateMonthlyPlan(newClient.id, packageSize, currentDate);
      }
  };

  const generateMonthlyPlan = async (clientId, packageSize, targetDate) => {
      const year = targetDate.getFullYear();
      const month = targetDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      let dayCounter = 1;
      const plan = [];
      const distribution15 = ['image', 'reel', 'carousel', 'ugc', 'image', 'clip', 'ugc', 'carousel', 'reel', 'image', 'ugc', 'image', 'clip', 'ugc', 'carousel'];
      
      while (plan.length < packageSize && dayCounter <= daysInMonth) {
          const type = packageSize === 15 
            ? distribution15[plan.length % distribution15.length]
            : ['image', 'reel', 'carousel', 'ugc', 'clip'][dayCounter % 5];
            
          const isVideo = ['reel', 'clip', 'ugc'].includes(type);
          
          await createItem('posts', {
              title: `Propuesta Automática: ${CONTENT_TYPES[type.toUpperCase()].label}`,
              date: new Date(year, month, dayCounter).toISOString().split('T')[0],
              type: type,
              networks: isVideo ? ['instagram', 'tiktok'] : ['instagram', 'facebook', 'linkedin'],
              status: 'proposal',
              client_id: clientId,
              observations: 'Generado por CORIA AI'
          });
          
          dayCounter += (packageSize === 15 ? 2 : 1);
      }
  };

  const getDaysInMonth = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const days = [];
    const firstDay = new Date(year, month, 1).getDay();
    const lastDay = new Date(year, month + 1, 0).getDate();
    for (let i = 0; i < firstDay; i++) days.push(null);
    for (let i = 1; i <= lastDay; i++) days.push(new Date(year, month, i));
    return days;
  };

  // --- VISTAS RENDERIZADAS ---

  if (!supabase && !isDemo) return <ConfigScreen onConnect={handleConnect} />;

  // HUB PRINCIPAL
  if (!selectedClient) {
      // Calcular métricas para el Hub
      const activeClientData = clients.map(c => {
          const cPosts = posts.filter(p => p.client_id === c.id);
          return { ...c, totalPosts: cPosts.length };
      });

      return (
        <div className={`min-h-screen ${THEME.bg} flex flex-col items-center p-8 font-sans`}>
            <header className="max-w-6xl w-full mb-12 text-center mt-10">
                <h1 className="text-6xl font-black text-slate-900 tracking-tighter mb-4">CORIA <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">Hub</span></h1>
                
                {/* Métricas Globales */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                   <GlassCard className="p-6 flex items-center justify-between">
                      <div className="text-left">
                          <p className="text-xs font-bold text-slate-400 uppercase">Producción Total</p>
                          <p className="text-3xl font-black text-slate-800">{posts.length}</p>
                      </div>
                      <div className="p-3 bg-indigo-50 text-indigo-600 rounded-xl"><BarChart2 /></div>
                   </GlassCard>
                   {/* Más métricas aquí... */}
                </div>
            </header>

            {/* Grid de Clientes */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl w-full">
                {activeClientData.map(client => (
                    <div key={client.id} onClick={() => setSelectedClient(client.id)} className="group h-64 relative cursor-pointer perspective-1000">
                        <div className={`absolute inset-0 bg-gradient-to-br ${client.theme} opacity-0 group-hover:opacity-100 transition-opacity duration-500 blur-2xl -z-10 rounded-[2rem] transform translate-y-4`}></div>
                        <div className="h-full bg-white rounded-[2rem] border border-slate-200 p-8 flex flex-col justify-between transition-all duration-300 group-hover:scale-[1.02] shadow-xl">
                            <div className="flex justify-between">
                                <div className={`w-14 h-14 rounded-2xl bg-gradient-to-br ${client.theme} flex items-center justify-center text-white font-bold text-xl shadow-lg`}>{client.logo}</div>
                            </div>
                            <div>
                                <h3 className="text-2xl font-bold text-slate-800">{client.name}</h3>
                                <p className="text-sm text-slate-400 mt-1">{client.totalPosts} posts activos</p>
                            </div>
                        </div>
                    </div>
                ))}
                
                {/* Botón Agregar Cliente (Simplificado) */}
                <button 
                  onClick={() => {
                      const name = prompt("Nombre del Cliente:");
                      if(name) {
                          const size = confirm("¿Añadir paquete de 15 posts automáticos?") ? 15 : 0;
                          handleAddClient(name, size);
                      }
                  }}
                  className="h-64 rounded-[2rem] border-4 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400 hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50/50 transition-all"
                >
                    <Plus size={40} />
                    <span className="font-bold text-lg mt-4">Nuevo Cliente</span>
                </button>
            </div>
        </div>
      );
  }

  // WORKSPACE DEL CLIENTE
  const activeClient = clients.find(c => c.id === selectedClient);
  const clientPosts = posts.filter(p => p.client_id === selectedClient);
  
  // Filtrar calendario
  const calendarPosts = clientPosts.filter(p => {
      const pDate = new Date(p.date + 'T00:00:00');
      return pDate.getMonth() === currentDate.getMonth() && pDate.getFullYear() === currentDate.getFullYear() && p.status !== 'idea';
  });

  return (
    <div className={`flex h-screen ${THEME.bg} overflow-hidden font-sans`}>
        {/* SIDEBAR */}
        <aside className="w-72 p-4 hidden lg:flex flex-col">
            <div className={`flex-1 ${THEME.sidebar} rounded-[2.5rem] shadow-2xl flex flex-col relative overflow-hidden`}>
                <div className="p-8 border-b border-white/10">
                    <button onClick={() => setSelectedClient(null)} className="text-slate-400 hover:text-white mb-6 block"><Grid /></button>
                    <h2 className="text-white font-bold text-2xl leading-none">{activeClient.name}</h2>
                    <p className="text-indigo-400 text-xs font-bold uppercase tracking-widest mt-2">Workspace</p>
                </div>
                <nav className="p-4 space-y-2 mt-4">
                    <button onClick={() => setCurrentView('planning')} className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all ${currentView==='planning' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                        <CalendarIcon size={20} /> <span className="font-bold">Calendario</span>
                    </button>
                    <button onClick={() => setCurrentView('inbox')} className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all ${currentView==='inbox' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                        <BookOpen size={20} /> <span className="font-bold">Buzón</span>
                    </button>
                    <button className="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                        <Target size={20} /> <span className="font-bold">Campañas</span>
                    </button>
                </nav>
            </div>
        </aside>

        {/* CONTENIDO */}
        <main className="flex-1 overflow-y-auto relative p-4 lg:p-8">
            <header className="flex justify-between items-center mb-8">
                 <div>
                     <h2 className="text-3xl font-black text-slate-800 flex items-center gap-3">
                        {currentView === 'planning' ? <><CalendarIcon className="text-indigo-600"/> Planificador</> : <><BookOpen className="text-indigo-600"/> Buzón Creativo</>}
                     </h2>
                     <p className="text-slate-500 font-medium ml-10">Gestión estratégica para {activeClient.name}</p>
                 </div>
                 <div className="flex gap-4">
                    {/* Botón Mágico solo en calendario */}
                    {currentView === 'planning' && (
                        <button 
                            onClick={() => {
                                if(confirm(`¿Generar plan automático para ${currentDate.toLocaleDateString('es-ES', { month: 'long' })}?`)) {
                                    generateMonthlyPlan(selectedClient, 15, currentDate);
                                }
                            }}
                            className="p-3 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white rounded-xl shadow-lg shadow-purple-200 hover:scale-105 transition-transform"
                            title="Auto-Planificar Mes"
                        >
                            <Wand2 size={20} />
                        </button>
                    )}
                    <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className="bg-slate-900 text-white px-6 py-3 rounded-full font-bold shadow-xl hover:scale-105 transition-transform flex items-center gap-2">
                        <Plus size={18} /> Crear Nuevo
                    </button>
                 </div>
            </header>

            {currentView === 'planning' && (
                <div className="space-y-6">
                    {/* Toolbar Calendario */}
                    <div className="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-slate-200">
                         <button onClick={() => setCurrentDate(d => new Date(d.getFullYear(), d.getMonth()-1, 1))} className="p-3 hover:bg-slate-50 rounded-xl text-slate-500"><ChevronLeft/></button>
                         <span className="text-lg font-bold text-slate-800 uppercase tracking-widest px-8">{currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</span>
                         <button onClick={() => setCurrentDate(d => new Date(d.getFullYear(), d.getMonth()+1, 1))} className="p-3 hover:bg-slate-50 rounded-xl text-slate-500"><ChevronRight/></button>
                    </div>

                    {/* Grid */}
                    <div className="bg-white rounded-[2rem] border border-slate-200 shadow-xl shadow-slate-200/50 overflow-hidden">
                        <div className="grid grid-cols-7 border-b border-slate-100 bg-slate-50">
                            {['DOM','LUN','MAR','MIÉ','JUE','VIE','SÁB'].map(d => (
                                <div key={d} className="py-4 text-center text-xs font-black text-slate-400">{d}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 auto-rows-fr bg-slate-50 gap-px">
                            {getDaysInMonth(currentDate).map((day, i) => {
                                if(!day) return <div key={`e-${i}`} className="bg-white min-h-[140px]" />
                                const dateStr = day.toISOString().split('T')[0];
                                const dayPosts = calendarPosts.filter(p => p.date === dateStr);
                                
                                return (
                                    <div key={dateStr} className="bg-white min-h-[140px] p-2 relative group hover:bg-indigo-50/10 transition-colors" onClick={() => { setNewPost({date: dateStr}); setEditingId(null); setIsModalOpen(true); }}>
                                        <span className="text-sm font-bold text-slate-400 ml-1">{day.getDate()}</span>
                                        <div className="mt-2 space-y-1">
                                            {dayPosts.map(post => {
                                                const type = CONTENT_TYPES[post.type.toUpperCase()] || CONTENT_TYPES.IMAGE;
                                                const status = STATUS_CONFIG[post.status] || STATUS_CONFIG.draft;
                                                return (
                                                    <div 
                                                        key={post.id} 
                                                        onClick={(e) => { e.stopPropagation(); setEditingId(post.id); setNewPost(post); setIsModalOpen(true); }}
                                                        className={`p-2 rounded-xl border text-xs cursor-pointer bg-white relative overflow-hidden shadow-sm hover:shadow-md transition-all group/card ${post.status === 'proposal' ? 'border-dashed opacity-70' : 'border-slate-100'}`}
                                                    >
                                                        <div className={`absolute left-0 top-0 bottom-0 w-1 ${status.dot.replace('bg-', 'bg-')}`}></div>
                                                        <div className="pl-2">
                                                            <div className={`flex items-center gap-1 font-bold ${type.color} mb-0.5`}>
                                                                <type.icon size={10} /> {type.label}
                                                            </div>
                                                            <p className="font-bold text-slate-700 truncate">{post.title}</p>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            )}
            
            {/* VISTA BUZÓN */}
            {currentView === 'inbox' && (
                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    {/* Tarjeta de Agregar Rápido */}
                    <div className="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-6 flex flex-col items-center justify-center text-slate-400 hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50 transition-all cursor-pointer" onClick={() => { setEditingId(null); setNewPost({status: 'idea'}); setIsModalOpen(true); }}>
                        <Lightbulb size={32} className="mb-2"/>
                        <span className="font-bold">Nueva Idea</span>
                    </div>
                    {/* Lista de Ideas */}
                    {clientPosts.filter(p => p.status === 'idea').map(idea => (
                        <GlassCard key={idea.id} className="p-6 relative group" onClick={() => { setEditingId(idea.id); setNewPost(idea); setIsModalOpen(true); }}>
                            <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={(e) => { e.stopPropagation(); deleteItem('posts', idea.id); }} className="text-slate-300 hover:text-red-500"><Trash2 size={16}/></button>
                            </div>
                            <p className="font-handwriting text-lg text-slate-700 mb-4">{idea.title}</p>
                            <div className="flex justify-between items-center mt-auto pt-4 border-t border-slate-100">
                                <span className="text-[10px] font-bold text-slate-400 uppercase">Idea</span>
                                <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-colors">
                                    <ArrowRight size={16} />
                                </div>
                            </div>
                        </GlassCard>
                    ))}
                </div>
            )}

        </main>

        {/* MODAL EDITOR */}
        {isModalOpen && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-md p-4">
                <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg p-8 animate-in zoom-in-95">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-2xl text-slate-800">{editingId ? 'Editar' : 'Crear'}</h3>
                        <button onClick={() => setIsModalOpen(false)}><X className="text-slate-400 hover:text-slate-600"/></button>
                    </div>
                    <form onSubmit={handleSave} className="space-y-4">
                        <input 
                            className="w-full text-lg font-medium border-b-2 border-slate-100 focus:border-indigo-500 outline-none pb-2" 
                            placeholder="Título o concepto..." 
                            value={newPost.title || ''} 
                            onChange={e => setNewPost({...newPost, title: e.target.value})} 
                            autoFocus
                        />
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Fecha</label>
                                <input type="date" className="w-full bg-slate-50 rounded-xl p-3 mt-1 outline-none" value={newPost.date || ''} onChange={e => setNewPost({...newPost, date: e.target.value})} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase">Formato</label>
                                <select className="
