<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coria Digital - Marketing Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f172a', /* Slate 900 */
                            800: '#1e293b', /* Slate 800 */
                            700: '#334155', /* Slate 700 */
                        },
                        brand: {
                            500: '#6366f1', /* Indigo 500 */
                            600: '#4f46e5', /* Indigo 600 */
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-dark-900 text-white h-screen flex overflow-hidden selection:bg-brand-500 selection:text-white">

    <!-- Config Modal (Overlay) -->
    <div id="configModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl transform transition-all scale-100">
            <h2 class="text-2xl font-bold mb-6 text-brand-500 flex items-center gap-2">
                <i data-lucide="database"></i> Configurar Supabase
            </h2>
            <p class="text-gray-400 mb-6 text-sm">Ingresa las credenciales de tu proyecto Supabase para conectar el
                dashboard.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Project URL</label>
                    <input type="text" id="supabaseUrl"
                        class="w-full bg-dark-800 border-gray-700 rounded-lg p-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none transition"
                        placeholder="https://xyz.supabase.co">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Anon Key</label>
                    <input type="password" id="supabaseKey"
                        class="w-full bg-dark-800 border-gray-700 rounded-lg p-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none transition"
                        placeholder="eyJh...">
                </div>
                <button onclick="saveConfig()"
                    class="w-full bg-gradient-to-r from-brand-600 to-purple-600 hover:from-brand-500 hover:to-purple-500 text-white font-semibold py-3 rounded-lg shadow-lg hover:shadow-brand-500/25 transition-all transform hover:-translate-y-0.5">
                    Conectar
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside
        class="w-20 lg:w-64 flex-shrink-0 bg-dark-800 border-r border-gray-800 flex flex-col transition-all duration-300">
        <div class="h-20 flex items-center justify-center lg:justify-start lg:px-8 border-b border-gray-800">
            <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-purple-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                <span class="font-bold text-white text-lg">C</span>
            </div>
            <span class="ml-3 font-bold text-xl hidden lg:block tracking-tight">Coria<span
                    class="text-brand-500">Digital</span></span>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-2 px-3">
            <button onclick="switchView('overview')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group active-nav">
                <i data-lucide="layout-dashboard" class="w-5 h-5 group-hover:text-brand-500 transition-colors"></i>
                <span class="hidden lg:block font-medium">Dashboard</span>
            </button>
            <button onclick="switchView('clients')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                <i data-lucide="users" class="w-5 h-5 group-hover:text-brand-500 transition-colors"></i>
                <span class="hidden lg:block font-medium">Clientes</span>
            </button>
            <button onclick="switchView('posts')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                <i data-lucide="instagram" class="w-5 h-5 group-hover:text-brand-500 transition-colors"></i>
                <span class="hidden lg:block font-medium">Publicaciones</span>
            </button>
            <button onclick="switchView('tasks')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                <i data-lucide="check-square" class="w-5 h-5 group-hover:text-brand-500 transition-colors"></i>
                <span class="hidden lg:block font-medium">Campañas</span>
            </button>
            <button onclick="switchView('extras')"
                class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                <i data-lucide="palette" class="w-5 h-5 group-hover:text-brand-500 transition-colors"></i>
                <span class="hidden lg:block font-medium">Diseños Extra</span>
            </button>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <button onclick="openConfig()"
                class="w-full flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="hidden lg:block font-medium">Configuración</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-dark-900 relative">
        <!-- Header -->
        <header class="h-20 glass sticky top-0 z-40 px-8 flex items-center justify-between">
            <h1 id="pageTitle"
                class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                Overview</h1>
            <div class="flex items-center gap-4">
                <div id="connectionStatus"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/10 text-red-500 text-xs font-semibold border border-red-500/20">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    Desconectado
                </div>
                <button onclick="refreshData()"
                    class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-colors">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto space-y-8">

            <!-- Views -->
            <div id="view-overview" class="view-section block animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="glass p-6 rounded-2xl hover:bg-white/5 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-brand-500/20 rounded-xl text-brand-500">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Clientes Activos</h3>
                        <p class="text-3xl font-bold mt-1" id="statClients">0</p>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:bg-white/5 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-purple-500/20 rounded-xl text-purple-500">
                                <i data-lucide="video" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Posts Programados</h3>
                        <p class="text-3xl font-bold mt-1" id="statPosts">0</p>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:bg-white/5 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-emerald-500/20 rounded-xl text-emerald-500">
                                <i data-lucide="check-circle" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Tareas Pendientes</h3>
                        <p class="text-3xl font-bold mt-1" id="statTasks">0</p>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:bg-white/5 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-pink-500/20 rounded-xl text-pink-500">
                                <i data-lucide="palette" class="w-6 h-6"></i>
                            </div>
                        </div>
                        <h3 class="text-gray-400 text-sm font-medium">Extras en Proceso</h3>
                        <p class="text-3xl font-bold mt-1" id="statExtras">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 glass rounded-2xl p-6">
                        <h2 class="text-lg font-bold mb-4">Actividad Reciente</h2>
                        <div id="recentActivity" class="space-y-4">
                            <!-- Populated by JS -->
                            <div class="text-gray-500 text-center py-8">Cargando actividad...</div>
                        </div>
                    </div>
                    <div class="glass rounded-2xl p-6">
                        <h2 class="text-lg font-bold mb-4">Accesos Rápidos</h2>
                        <div class="space-y-3">
                            <button onclick="openModal('clientModal')"
                                class="w-full text-left p-3 rounded-xl bg-dark-800 hover:bg-dark-700 transition flex items-center gap-3 border border-gray-700/50">
                                <div class="bg-blue-500/20 p-2 rounded-lg text-blue-500"><i data-lucide="plus"
                                        class="w-4 h-4"></i></div>
                                <span class="text-sm font-medium">Nuevo Cliente</span>
                            </button>
                            <button onclick="openModal('postModal')"
                                class="w-full text-left p-3 rounded-xl bg-dark-800 hover:bg-dark-700 transition flex items-center gap-3 border border-gray-700/50">
                                <div class="bg-purple-500/20 p-2 rounded-lg text-purple-500"><i data-lucide="plus"
                                        class="w-4 h-4"></i></div>
                                <span class="text-sm font-medium">Nueva Publicación</span>
                            </button>
                            <button onclick="openModal('taskModal')"
                                class="w-full text-left p-3 rounded-xl bg-dark-800 hover:bg-dark-700 transition flex items-center gap-3 border border-gray-700/50">
                                <div class="bg-emerald-500/20 p-2 rounded-lg text-emerald-500"><i data-lucide="plus"
                                        class="w-4 h-4"></i></div>
                                <span class="text-sm font-medium">Nueva Campaña</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients View -->
            <div id="view-clients" class="view-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Listado de Clientes</h2>
                    <button onclick="openModal('clientModal')"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Nuevo Cliente
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="clientsGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Posts View -->
            <div id="view-posts" class="view-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Planificación de Contenido</h2>
                    <button onclick="openModal('postModal')"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Nueva Publicación
                    </button>
                </div>
                <div class="overflow-x-auto pb-4">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-gray-400 text-xs uppercase tracking-wider border-b border-gray-800">
                                <th class="p-4 font-medium">Título</th>
                                <th class="p-4 font-medium">Cliente</th>
                                <th class="p-4 font-medium">Tipo</th>
                                <th class="p-4 font-medium">Estado</th>
                                <th class="p-4 font-medium">Plataformas</th>
                                <th class="p-4 font-medium">Fecha</th>
                                <th class="p-4 font-medium text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="postsTableBody" class="text-sm divide-y divide-gray-800/50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tasks View -->
            <div id="view-tasks" class="view-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Gestión de Campañas</h2>
                    <button onclick="openModal('taskModal')"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Nueva Campaña
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="tasksBoard">
                    <!-- Kanban Columns (Pending, Active, Done) -->
                    <div class="glass rounded-xl p-4 flex flex-col h-full bg-dark-800/50">
                        <h3
                            class="font-bold text-gray-400 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span> Pendientes
                        </h3>
                        <div id="tasks-pending" class="space-y-3 flex-1 min-h-[200px]"></div>
                    </div>
                    <div class="glass rounded-xl p-4 flex flex-col h-full bg-dark-800/50">
                        <h3
                            class="font-bold text-gray-400 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span> Activas
                        </h3>
                        <div id="tasks-active" class="space-y-3 flex-1 min-h-[200px]"></div>
                    </div>
                    <div class="glass rounded-xl p-4 flex flex-col h-full bg-dark-800/50">
                        <h3
                            class="font-bold text-gray-400 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Finalizadas
                        </h3>
                        <div id="tasks-done" class="space-y-3 flex-1 min-h-[200px]"></div>
                    </div>
                </div>
            </div>

            <!-- Extras View -->
            <div id="view-extras" class="view-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Diseños Extra</h2>
                    <button onclick="openModal('extraModal')"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Nuevo Extra
                    </button>
                </div>
                <div id="extrasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

        </div>
    </main>

    <!-- Modals -->
    <!-- Add Client Modal -->
    <div id="clientModal"
        class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-6 rounded-2xl w-full max-w-lg m-4">
            <h3 class="text-xl font-bold mb-4">Nuevo Cliente</h3>
            <form onsubmit="handleCreateClient(event)" class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Nombre</label>
                    <input type="text" name="name" required
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none">
                </div>
                <!-- Simple theme color picker logic could go here, keeping it text for now as per schema -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Tema (Hex Color)</label>
                        <input type="text" name="theme" placeholder="#000000"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Logo URL (Opcional)</label>
                        <input type="text" name="logo"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('clientModal')"
                        class="px-4 py-2 text-gray-400 hover:text-white transition">Cancelar</button>
                    <button type="submit"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded-lg font-medium transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Post Modal -->
    <div id="postModal"
        class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-6 rounded-2xl w-full max-w-2xl m-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Nueva Publicación</h3>
            <form onsubmit="handleCreatePost(event)" class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Título / Concepto</label>
                    <input type="text" name="title" required
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Cliente</label>
                        <select id="postClientSelect" name="client_id" required
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none text-gray-300">
                            <option value="">Seleccionar...</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Fecha</label>
                        <input type="date" name="date"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none schemed-dark">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Tipo</label>
                        <select name="type"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none text-gray-300">
                            <option value="reel">Reel</option>
                            <option value="clip">Clip</option>
                            <option value="ugc">UGC</option>
                            <option value="image">Imagen</option>
                            <option value="carousel">Carrusel</option>
                            <option value="note">Nota</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Estado</label>
                        <select name="status"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none text-gray-300">
                            <option value="idea">Idea</option>
                            <option value="proposal">Propuesta</option>
                            <option value="draft">Borrador</option>
                            <option value="ready">Listo</option>
                            <option value="scheduled">Programado</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Redes (Ctrl+Click para múltiple)</label>
                    <select name="networks" multiple
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none text-gray-300 h-24">
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                        <option value="facebook">Facebook</option>
                        <option value="youtube">YouTube</option>
                        <option value="linkedin">LinkedIn</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Observaciones</label>
                    <textarea name="observations" rows="3"
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none"></textarea>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('postModal')"
                        class="px-4 py-2 text-gray-400 hover:text-white transition">Cancelar</button>
                    <button type="submit"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded-lg font-medium transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="taskModal"
        class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-6 rounded-2xl w-full max-w-lg m-4">
            <h3 class="text-xl font-bold mb-4">Nueva Campaña / Tarea</h3>
            <form onsubmit="handleCreateTask(event)" class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Título</label>
                    <input type="text" name="title" required
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Cliente</label>
                        <select id="taskClientSelect" name="client_id" required
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none text-gray-300">
                            <!-- Populated JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 uppercase mb-1">Plataforma</label>
                        <select name="platform"
                            class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none text-gray-300">
                            <option value="meta">Meta (FB/IG)</option>
                            <option value="google">Google Ads</option>
                            <option value="tiktok">TikTok Ads</option>
                            <option value="linkedin">LinkedIn</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 uppercase mb-1">Estado</label>
                    <select name="status"
                        class="w-full bg-dark-800 border border-gray-700 rounded-lg p-2.5 focus:border-brand-500 outline-none text-gray-300">
                        <option value="pending">Pendiente</option>
                        <option value="active">Activa</option>
                        <option value="done">Finalizada</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('taskModal')"
                        class="px-4 py-2 text-gray-400 hover:text-white transition">Cancelar</button>
                    <button type="submit"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded-lg font-medium transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- State Management ---
        let supabase = null;
        let clients = [];
        let posts = [];
        let tasks = [];
        let extras = [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initIcons();
            checkConfig();
        });

        function initIcons() {
            lucide.createIcons();
        }

        // --- Configuration & Supabase Setup ---
        function checkConfig() {
            const url = localStorage.getItem('sb_url');
            const key = localStorage.getItem('sb_key');

            if (!url || !key) {
                openConfig();
            } else {
                initSupabase(url, key);
            }
        }

        function openConfig() {
            document.getElementById('configModal').classList.remove('hidden');
            document.getElementById('supabaseUrl').value = localStorage.getItem('sb_url') || '';
            document.getElementById('supabaseKey').value = localStorage.getItem('sb_key') || '';
        }

        function saveConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (url && key) {
                localStorage.setItem('sb_url', url);
                localStorage.setItem('sb_key', key);
                document.getElementById('configModal').classList.add('hidden');
                initSupabase(url, key);
            } else {
                alert('Por favor, ingresa ambos campos');
            }
        }

        async function initSupabase(url, key) {
            try {
                // Initialize Supabase client
                // Note: Using a global variable for simplicity in this single-file demo
                supabase = window.supabase.createClient(url, key);

                // Update UI status
                const statusEl = document.getElementById('connectionStatus');
                statusEl.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 text-green-500 text-xs font-semibold border border-green-500/20 transition-all';
                statusEl.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div> Conectado';

                // Fetch initial data
                await refreshData();

                // Setup realtime support (optional, simple polling or subscription)
                // For this demo, we'll subscribe to changes
                setupRealtime();

            } catch (err) {
                console.error("Supabase init error:", err);
                alert("Error conectando a Supabase. Verifica tus credenciales.");
            }
        }

        // --- Data Fetching ---
        async function refreshData() {
            if (!supabase) return;

            // Fetch Clients
            const { data: dataClients } = await supabase.from('clients').select('*').order('created_at', { ascending: false });
            clients = dataClients || [];

            // Fetch Posts
            const { data: dataPosts } = await supabase.from('posts').select('*, clients(name, theme)').order('date', { ascending: true });
            posts = dataPosts || [];

            // Fetch Tasks
            const { data: dataTasks } = await supabase.from('tasks').select('*, clients(name)').order('created_at', { ascending: false });
            tasks = dataTasks || [];

            // Fetch Extras
            const { data: dataExtras } = await supabase.from('extras').select('*, clients(name)').order('created_at', { ascending: false });
            extras = dataExtras || [];

            updateUI();
        }

        function setupRealtime() {
            // Simple blanket subscription to all 4 tables
            supabase.channel('public:any')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clients' }, payload => { refreshData() })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, payload => { refreshData() })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, payload => { refreshData() })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'extras' }, payload => { refreshData() })
                .subscribe();
        }

        // --- UI Updates ---
        function updateUI() {
            // Update Stats
            document.getElementById('statClients').innerText = clients.length;
            document.getElementById('statPosts').innerText = posts.filter(p => p.status === 'scheduled').length;
            document.getElementById('statTasks').innerText = tasks.filter(t => t.status === 'pending').length;
            document.getElementById('statExtras').innerText = extras.filter(e => e.status === 'working').length;

            // Update Recent Activity
            renderRecentActivity();

            // Update Views
            renderClients();
            renderPosts();
            renderTasks();

            // Update Selects in Modals
            updateClientSelects();
        }

        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            // Combine recent items (simple approach)
            const allItems = [
                ...posts.map(p => ({ type: 'post', date: p.created_at, title: p.title, status: p.status })),
                ...tasks.map(t => ({ type: 'task', date: t.created_at, title: t.title, status: t.status }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            if (allItems.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">No hay actividad reciente.</div>';
                return;
            }

            container.innerHTML = allItems.map(item => {
                let icon = item.type === 'post' ? 'instagram' : 'check-square';
                let color = item.type === 'post' ? 'text-purple-500' : 'text-emerald-500';
                let bg = item.type === 'post' ? 'bg-purple-500/10' : 'bg-emerald-500/10';

                return `
                    <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-white/5 transition">
                        <div class="p-2 rounded-lg ${bg} ${color}">
                            <i data-lucide="${icon}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm text-gray-200">${item.title}</p>
                            <p class="text-xs text-gray-500 capitalize">${item.type === 'post' ? 'Publicación' : 'Campaña'} • ${item.status}</p>
                        </div>
                        <div class="ml-auto text-xs text-gray-600">
                            ${new Date(item.date).toLocaleDateString()}
                        </div>
                    </div>
                 `;
            }).join('');
            initIcons();
        }

        function renderClients() {
            const grid = document.getElementById('clientsGrid');
            grid.innerHTML = clients.map(client => `
                <div class="glass p-6 rounded-2xl group hover:border-brand-500/50 transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-gray-800 text-gray-400 border border-gray-700" style="background-color: ${client.theme}20; color: ${client.theme}; border-color: ${client.theme}40">
                             ${client.logo ? `<img src="${client.logo}" class="w-full h-full object-cover rounded-full" />` : client.name.substring(0, 2).toUpperCase()}
                        </div>
                        <button onclick="deleteItem('clients', '${client.id}')" class="text-gray-600 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <h3 class="font-bold text-lg">${client.name}</h3>
                    <div class="mt-4 flex gap-2">
                         <span class="text-xs px-2 py-1 rounded bg-white/5 text-gray-400 border border-white/5">ID: ${client.id.substring(0, 8)}...</span>
                    </div>
                </div>
            `).join('');
            initIcons();
        }

        function renderPosts() {
            const tbody = document.getElementById('postsTableBody');
            tbody.innerHTML = posts.map(post => {
                const clientName = post.clients?.name || 'Unknown';
                const statusColors = {
                    idea: 'bg-gray-500/20 text-gray-400',
                    proposal: 'bg-blue-500/20 text-blue-400',
                    draft: 'bg-yellow-500/20 text-yellow-400',
                    ready: 'bg-emerald-500/20 text-emerald-400',
                    scheduled: 'bg-purple-500/20 text-purple-400',
                };

                return `
                <tr class="hover:bg-white/5 transition-colors group">
                    <td class="p-4 font-medium">${post.title}</td>
                    <td class="p-4 text-gray-400">${clientName}</td>
                    <td class="p-4"><span class="capitalize text-gray-400">${post.type}</span></td>
                    <td class="p-4"><span class="px-2 py-1 rounded-md text-xs font-semibold ${statusColors[post.status] || 'bg-gray-800'}">${post.status}</span></td>
                    <td class="p-4 text-gray-400 flex gap-1">${(post.networks || []).map(n => n.substring(0, 1).toUpperCase()).join(', ')}</td>
                    <td class="p-4 text-gray-400">${post.date || '-'}</td>
                     <td class="p-4 text-right">
                        <button onclick="deleteItem('posts', '${post.id}')" class="text-gray-600 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            initIcons();
        }

        function renderTasks() {
            // Group By Status
            const pending = tasks.filter(t => t.status === 'pending');
            const active = tasks.filter(t => t.status === 'active');
            const done = tasks.filter(t => t.status === 'done');

            const renderCard = (task) => `
                <div class="bg-dark-900 border border-gray-800 p-4 rounded-lg hover:border-brand-500/50 transition cursor-pointer group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-brand-500 font-medium">${task.clients?.name || 'Client'}</span>
                         <button onclick="deleteItem('tasks', '${task.id}')" class="text-gray-600 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                             <i data-lucide="x" class="w-3 h-3"></i>
                         </button>
                    </div>
                    <h4 class="font-bold text-sm mb-2 text-gray-200">${task.title}</h4>
                    <div class="flex items-center justify-between mt-3">
                         <span class="text-xs px-2 py-1 rounded bg-white/5 text-gray-500 capitalize">${task.platform || 'General'}</span>
                         
                         <!-- Simple Status Switcher -->
                         <div class="flex gap-1">
                            ${task.status !== 'pending' ? `<button onclick="updateStatus('tasks', '${task.id}', 'pending')" class="p-1 hover:bg-white/10 rounded text-gray-500" title="Pendiente"><i data-lucide="arrow-left" class="w-3 h-3"></i></button>` : ''}
                            ${task.status !== 'done' ? `<button onclick="updateStatus('tasks', '${task.id}', 'done')" class="p-1 hover:bg-white/10 rounded text-gray-500" title="Finalizar"><i data-lucide="check" class="w-3 h-3"></i></button>` : ''}
                             ${task.status === 'pending' ? `<button onclick="updateStatus('tasks', '${task.id}', 'active')" class="p-1 hover:bg-white/10 rounded text-gray-500" title="Activar"><i data-lucide="play" class="w-3 h-3"></i></button>` : ''}
                         </div>
                    </div>
                </div>
            `;

            document.getElementById('tasks-pending').innerHTML = pending.map(renderCard).join('');
            document.getElementById('tasks-active').innerHTML = active.map(renderCard).join('');
            document.getElementById('tasks-done').innerHTML = done.map(renderCard).join('');
            initIcons();
        }

        // --- Form Handling ---
        function updateClientSelects() {
            const opts = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('postClientSelect').innerHTML = '<option value="">Seleccionar...</option>' + opts;
            document.getElementById('taskClientSelect').innerHTML = '<option value="">Seleccionar...</option>' + opts;
        }

        async function handleCreateClient(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const { error } = await supabase.from('clients').insert([data]);
            if (error) alert(error.message);
            else { closeModal('clientModal'); e.target.reset(); refreshData(); }
        }

        async function handleCreatePost(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Handle multiselect
            const networks = Array.from(e.target.querySelector('select[name="networks"]').selectedOptions).map(o => o.value);

            const data = {
                title: formData.get('title'),
                client_id: formData.get('client_id'),
                date: formData.get('date'),
                type: formData.get('type'),
                status: formData.get('status'),
                observations: formData.get('observations'),
                networks: networks
            };

            const { error } = await supabase.from('posts').insert([data]);
            if (error) alert(error.message);
            else { closeModal('postModal'); e.target.reset(); refreshData(); }
        }

        async function handleCreateTask(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const { error } = await supabase.from('tasks').insert([data]);
            if (error) alert(error.message);
            else { closeModal('taskModal'); e.target.reset(); refreshData(); }
        }

        // --- Actions ---
        async function deleteItem(table, id) {
            if (!confirm('¿Estás seguro de eliminar este elemento?')) return;
            const { error } = await supabase.from(table).delete().eq('id', id);
            if (error) alert('Error: ' + error.message);
            else refreshData();
        }

        async function updateStatus(table, id, status) {
            const { error } = await supabase.from(table).update({ status }).eq('id', id);
            if (error) alert('Error: ' + error.message);
            else refreshData();
        }

        // --- Views & Modals ---
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('block', 'animate-fade-in');
            });
            // Show selected view
            const selected = document.getElementById('view-' + viewName);
            selected.classList.remove('hidden');
            selected.classList.add('block', 'animate-fade-in');

            // Update Title
            const titles = {
                overview: 'Overview',
                clients: 'Clientes',
                posts: 'Publicaciones',
                tasks: 'Campañas',
                extras: 'Diseños Extra'
            };
            document.getElementById('pageTitle').innerText = titles[viewName];

            // Update Nav State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav', 'bg-white/5', 'text-white'));
            // Find button that called this (a bit hacky but works for demo)
            // ... omitting complex nav active state logic for brevity, just reset all
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

    </script>
</body>

</html>
